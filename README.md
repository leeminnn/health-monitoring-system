# health-monitoring-system

# generator.py
This is the code repository for sample code to locally generate IoT device data similar to what is generated by the [AWS Simple Beer Service](https://github.com/awslabs/simplebeerservice) devices, and feed it to AWS IoT service.

### Pre-requisites

* Amazon Web Services account
* [AWS Command Line Interface (CLI)](https://aws.amazon.com/cli/)
* Python
* boto3

### Script Details

The script generates random values (within a reasonable range) for each of the three parameters- Heart Rate, Oxygen Level, and Blood Pressure, with 20% chance of an abnormal reading appearing randomly (to signal an alert for the doctors). 

This script was originally taken from [aws-samples](https://github.com/aws-samples/sbs-iot-data-generator).

### Running Example

`$ python generator.py` 
<br>

### !!IMPORTANT: TO BE MODIFIED BEFORE DEPLOYMENT!!!!
```
#line 15
queue = sqs.create_queue(QueueName='test', Attributes={'DelaySeconds': '5'}) 
```
This line creates a new SQS queue called 'test' but it should be modified to a more suitable name. DelaySeconds should also be modifed accordingly to determine the rate at which the consumer sees the message. A delay queue let you postpone the delivery of new messages to consumers for a number of seconds, meaning any messages that you send to the queue remain invisible to consumers for the duration of the delay period.
```
#line 55
LIMIT = 5
```
This line determines the MAX number of messages sent from all the IoT devices to the SQS queue. As SQS free tier has a limit of 1 million requests per month, this should be modified accordingly depending on needs. <br>
E.g. performance test = ~20,000 requests, regular test = ~100 requests
```
#line 22
    unhealthyHR = random.randint(40,120)
    data['deviceValue'] = random.choices([healthyHR, unhealthyHR],[0.8, 0.2])[0]
...
#line 34
    unhealthyO2 = random.randint(90,100)
    data['deviceValue'] = random.choices([healthyO2, unhealthyO2],[0.8, 0.2])[0]
...
#line 46
    unhealthyBP = random.randint(80,150)
    data['deviceValue'] = random.choices([healthyBP, unhealthyBP],[0.8, 0.2])[0]
...
```
For testing of the special alert cases, any of these lines of code can be modified to return more extreme values to trigger the alert service. Modify the range of unhealthy value and the probability of unhealthy value in the `random.choices()`
<br>

## alert.py
This is the code repository to retrieve messages from a particular SQS queue and feed it to an AWS IoT service when the preset trigger is activated.

### Pre-requisites

* Amazon Web Services account
* [AWS Command Line Interface (CLI)](https://aws.amazon.com/cli/)
* Python
* boto3

### Script Details
The script takes in messages from a predetermined SQS queue and checks the body of each message to filter out for messages that exceed the predetermined healthy/normal range. This indicates an anomaly and is sent to DynamoDb to be stored.

### Running Example

`$ python alert.py` 
<br>

### !!IMPORTANT: TO BE MODIFIED BEFORE DEPLOYMENT!!!!
```
#line 7
queue_url = 'https://sqs.ap-southeast-1.amazonaws.com/331534983030/test' 
```
After the queue has been created by generator.py, go to AWS SQS to copy the URL and replace it in the code.
```
#line 14
response = iot.publish(
             topic='/alert',
             payload=data
    ) 
```
The name of the topic '/alert' can be modified but should match the rule query statement in AWS IoT Rule. <br>
E.g. topic: `'/alert'` <br>
Rule query statement: `SELECT * FROM '/alert'`

## Run the script on Amazon EC2 Instance

To run it from an Amazon EC2 instance. Follow these steps:

1. Create an IAM role with a policy that gives access to IoT (example: AWSIoTFullAccess)
2. Launch a new EC2 instance and assign it the IoT IAM role at launch
3. Login to the EC2 instance and change to root user `sudo su`
4. Set your default region and output format in `aws configure`
> Access Key ID: \<your access key> <br>
Secret Access Key: \<your secret access key> <br>
Default region: ap-southeast-1 <br>
Default output format: json
5. Upload `generator.py` file to EC2, or `nano generator.py`, copy the entire script, save and exit
6. ~~Make sure you have boto3 installed. If not, type `pip install boto3`~~
7. ~~Run `python generator.py`~~
6. Check if you have pip with `pip --version`
    else: `python -m ensurepip --upgrade`
7. Use pip to install Pipenv: `pip install --user pipenv`
8. Install boto3 package: `pipenv install boto3`
9. Run `sbs.py` from ec2: `pipenv run python generator.py`

## Retrieve data using IoT Rules:

1. Go to AWS IoT Rules and create a new rule
2. Include rule query statement: `SELECT * FROM '/sbs/devicedata/#'`
> keep the topic filter (/sbs/devicedata/#') the same unless you change it in the sbs.py file
3. Select what you want to do with the data (action):
> E.g. Send a message to an SQS queue (but you will have to create the queue in advance)

## Common Errors:
## SSL Error
```
botocore.exceptions.SSLError: SSL validation failed for [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed
```
Debugging:
- Check ec2 instance was given IAM role with IOT full access
- Check if IoT rule topic is set correctly
- Try 
```
python3 -m pip install boto3
python3 alert.py
```

## pipenv command not found
```
bash: pipenv: command not found
```
Debugging:
- Try
```
python3 -m pip install boto3
python3 alert.py
```
- Note: Boto3 will no longer support Python 2.7 starting July 15, 2021. To continue receiving service updates, bug fixes, and security updates please upgrade to Python 3.6 or later.

